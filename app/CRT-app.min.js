var CRT=angular.module("CRT",["ngRoute","ngAnimate","LocalStorageModule","ngUtils","sprintf","dotjem.angular.tree"]);CRT.config(["$routeProvider",function(e){e.when("/",{templateUrl:"app/partial/list_stories.html",controller:"HackerNewsController"}).otherwise({redirectTo:"/"})}]),CRT.config(["localStorageServiceProvider",function(e){e.setPrefix("CRT").setStorageType("localStorage").setNotify(!0,!0)}]),CRT.controller("HackerNewsController",["$scope","$filter","$timeout","$interval","HackerNewsAPI","localStorageService","NavbarService",function(e,t,n,o,r,s,i){"use strict";function a(){if(console.log("Clearing excess items"),e.hnews.length>h.maxNumStories){var t=new Worker(h.workerRemoveItemsPath);t.postMessage({items:e.hnews,limit:h.maxNumStories}),t.onmessage=function(n){var o=n.data;o instanceof Array&&o.length>0&&(o.forEach(function(t){var n=_.findIndex(e.hnews,function(e){return e.id===t});n>=0&&e.hnews.splice(n,1)}),e.$apply(function(){e.numItems.items=e.hnews.length})),t.terminate()},t.onerror=function(e){console.log("worker ERROR"),console.log(e),t.terminate()}}}function c(){var e=r.topStories();e.then(function(e){e.forEach(function(e){var t=r.getItem(e);t.then(function(e){m(e)})})}),n(a,h.clearExcessItemsTimeout)}function m(t){var n=-1;return void 0!==t&&(n=_.findIndex(e.hnews,function(e){return e.id===t.id}),n=-1===n?l(t):u(t,n)),n}function l(t){return console.log("New story added"),e.numItems.items=e.hnews.length,e.hnews.push(t)-1}function u(t,n){var o=e.hnews[n],r=!1;return angular.forEach(t,function(s,i){r=!1,r="commentsIds"===i?o[i].length!==s.length:o[i]!==s,r&&(e.hnews[n]=t,console.log("Story updated"))}),n}function d(e,t){void 0===t&&(t=[]),e.forEach(function(e){if(g+=1,w>=g){var n=r.getItem(e);n.then(function(e){if(f(e)){var n={id:e.id,author:e.by,text:e.text,time:e.time,kids:e.kids||[],childComments:[]};n.kids.length>0&&d(n.kids,n.childComments),t.push(n)}})}})}function f(e){return null!==e&&void 0!==e&&!e.hasOwnProperty("dead")&&void 0!==e.text}var h={storiesLocalStorageKey:"hackernews",maxNumStories:100,clearExcessItemsTimeout:2e4,refreshStoriesInterval:6e4,workerRemoveItemsPath:"app/worker/removeExcessItems.min.js"},v=t("orderBy"),g=0,w=20;!function(){var t=s.get(h.storiesLocalStorageKey);e.hnews=t instanceof Array?t:[],e.comments={},e.loader={},e.search=i.search,e.numItems=i.numItems,s.bind(e,"hnews",e.hnews,h.storiesLocalStorageKey),c(),o(c,h.refreshStoriesInterval),e.numItems.items=e.hnews.length}(),e.$on("sortCommand",function(t,n,o){e.hnews=v(e.hnews,n,o)}),e.$on("refreshCommand",function(){c()}),e.loadComments=function(t,n){var o=_.findIndex(e.hnews,function(e){return e.id===t});if(-1!==o){if(e.loader[t]=!e.loader[t],e.comments[t]=[],!n)return void(e.loader[t]=!1);g=0,d(e.hnews[o].commentsIds,e.comments[t]);var r=setInterval(function(){(g>=w||g>=e.hnews[o].commentsIds.length)&&(e.$apply(function(){e.loader[t]=!1}),clearInterval(r))},1e3)}},e.loadCommentsChildren=function(e){g=0,d(e.kids,e.childComments)},e.loadMoreComments=function(t){var n=_.findIndex(e.hnews,function(e){return e.id===t}),o=_.difference(e.hnews[n].commentsIds,_(e.comments[t]).filter("id").map(function(e){return e.id}).value());g=0,d(o,e.comments[t])},e.timeAgoFromEpochTime=function(e){return Utils.timeAgoFromEpochTime(e)},e.resetNewsList=function(){console.log("Removing and refreshing news list"),e.hnews=[],e.comments=[]},e.clearLocalStorage=function(){console.log("Clearing Local Storage"),s.clearAll()},window.scope=e}]),CRT.controller("NavbarController",["$scope","$rootScope","NavbarService",function(e,t,n){"use strict";e.filterOrderBy=function(e,n){t.$broadcast("sortCommand",e,n)},e.refreshStories=function(){t.$broadcast("refreshCommand")},function(){e.search=n.search,e.numItems=n.numItems}()}]),CRT.service("HackerNewsAPI",["$filter","$q",function(e,t){"use strict";function n(e){if(void 0!==e&&void 0!==e.kids&&!e.dead){var t=""!==e.url?e.url:r(o.commentsURL,e.id),n=r(o.commentsURL,e.id),s="";try{s=new URL(""!==e.url?e.url:n).hostname,s=s.replace("www.","")}catch(i){console.log("Failed getting hostname: "+i),s=n}return{id:e.id,url:t,commentsURL:n,commentsIds:e.kids,commentCount:e.descendants,author:e.by,title:e.title,text:e.text,domain:s,time:e.time,score:e.score}}}var o={maxNumStories:100,hnFirebaseRefs:{topStories:"https://hacker-news.firebaseio.com/v0/topstories",item:"https://hacker-news.firebaseio.com/v0/item/%s"},commentsURL:"https://news.ycombinator.com/item?id=%s"},r=e("sprintf"),s={};return s.topStories=function(){var e=t.defer();return new Firebase(o.hnFirebaseRefs.topStories).limitToFirst(o.maxNumStories).once("value",function(t){var n=t.val();n instanceof Array?e.resolve(n):e.reject([])},function(t){console.log("The read failed: "+t.code),e.reject([])}),e.promise},s.getItem=function(e){var s=t.defer();return new Firebase(r(o.hnFirebaseRefs.item,e)).orderByChild("id").once("value",function(e){s.resolve(n(e.val()))},function(e){console.log("The read failed: "+e.code),s.reject([])}),s.promise},s}]),CRT.factory("NavbarService",function(){"use strict";var e={};return e.search={term:""},e.numItems={items:0},e});