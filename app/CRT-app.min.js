var CRT=angular.module("CRT",["ngRoute","LocalStorageModule","ngUtils","sprintf","dotjem.angular.tree"]);CRT.config(["$routeProvider",function(e){e.when("/",{templateUrl:"app/partial/list_stories.html",controller:"HackerNewsController"}).when("/story/:id",{templateUrl:"app/partial/story.html",controller:"StoryController"}).otherwise({redirectTo:"/"})}]),CRT.config(["localStorageServiceProvider",function(e){e.setPrefix("CRT").setStorageType("localStorage").setNotify(!0,!0)}]),CRT.constant("GlobalConfig",{localStorage:{storiesKey:"hnStories",commentsFormatKey:"hnComments.%s",commentsExpirationFormatKey:"%s%s",commentsExpiration:36e5,expirationPrefixKey:"#"}}),CRT.directive("newsItem",function(){return{restrict:"E",scope:{item:"=",comments:"=",loader:"=",loadComments:"&",loadCommentsChildren:"&",loadMoreComments:"&",timeAgo:"&"},templateUrl:"app/directive/crtNewsItem.html"}}),CRT.controller("HackerNewsController",["$scope","$filter","$timeout","$interval","HackerNewsListService","localStorageService","NavbarService","GlobalConfig",function(e,t,o,r,n,i,s,a){"use strict";var c={localStorage:a.localStorage},m=t("orderBy");!function(){e.hnews=n.storiesList,e.search=s.search,s.actions.enabled=!0,i.bind(e,"hnews",e.hnews,c.localStorage.storiesKey)}(),e.$on("sortCommand",function(t,o,r){e.hnews=m(e.hnews,o,r)}),e.$on("refreshCommand",function(){n.getStories()}),window.scope=e}]),CRT.controller("NavbarController",["$scope","$rootScope","NavbarService",function(e,t,o){"use strict";e.filterOrderBy=function(e,o){t.$broadcast("sortCommand",e,o)},e.refreshStories=function(){t.$broadcast("refreshCommand")},function(){e.search=o.search,e.actions=o.actions}()}]),CRT.controller("StoryController",["$scope","$routeParams","$interval","HackerNewsListService","NavbarService",function(e,t,o,r,n){"use strict";var i={refreshCommentsInterval:3e4};!function(){e.story=r.getStory(t.id),r.getComments(t.id);var s=r.storyComments;e.comments=s[t.id],n.actions.enabled=!1;var a=o(function(){r.getComments(t.id,!0)},i.refreshCommentsInterval);e.$on("$destroy",function(){a&&o.cancel(a)})}(),window.scope=e}]),CRT.service("HackerNewsAPI",["$filter","$q",function(e,t){"use strict";function o(e){if(void 0!==e&&void 0!==e.kids&&!e.dead){var t=""!==e.url?e.url:a(s.commentsURL,e.id),o=a(s.commentsURL,e.id),r="";try{r=new URL(""!==e.url?e.url:o).hostname,r=r.replace("www.","")}catch(n){console.log("Failed getting hostname: "+n),r=o}return{id:e.id,url:t,commentsURL:o,commentsIds:e.kids,commentCount:e.descendants,author:e.by,title:e.title,text:e.text,domain:r,time:e.time,score:e.score}}}function r(e){return n(e)?{id:e.id,author:e.by,text:e.text,time:e.time,kids:e.kids||[],childComments:[]}:void 0}function n(e){return null!==e&&void 0!==e&&!e.hasOwnProperty("dead")&&void 0!==e.text}function i(e,n){var i=t.defer();return new Firebase(a(s.hnFirebaseRefs.item,e)).orderByChild("id").once("value",function(e){i.resolve(n===c?r(e.val()):o(e.val()))},function(e){console.log("The read failed: "+e.code),i.reject(!1)}),i.promise}var s={maxNumStories:100,hnFirebaseRefs:{topStories:"https://hacker-news.firebaseio.com/v0/topstories",item:"https://hacker-news.firebaseio.com/v0/item/%s"},commentsURL:"https://news.ycombinator.com/item?id=%s"},a=e("sprintf"),c="CMT",m={};return m.topStories=function(){var e=t.defer();return new Firebase(s.hnFirebaseRefs.topStories).limitToFirst(s.maxNumStories).once("value",function(t){var o=t.val();o instanceof Array?e.resolve(o):e.reject([])},function(t){console.log("The read failed: "+t.code),e.reject([])}),e.promise},m.getItem=function(e){return i(e)},m.getItemComment=function(e){return i(e,c)},m}]),CRT.factory("NavbarService",function(){"use strict";var e={};return e.search={term:""},e.actions={enabled:!0},e}),CRT.factory("HackerNewsListService",["localStorageService","HackerNewsAPI","GlobalConfig","$filter","$interval","$timeout",function(e,t,o,r,n,i){"use strict";function s(){var e=t.topStories();e.then(function(e){e.forEach(function(e){var o=t.getItem(e);o.then(function(e){c(e)})})}),i(f,h.clearExcessItemsTimeout)}function a(e){return e=parseInt(e,10),_.findIndex(S,function(t){return t.id===e})}function c(e){var t=-1;return void 0!==e&&(t=a(e.id),t=-1===t?m(e):l(e,t)),t}function m(e){return console.info("New story added"),S.push(e)-1}function l(e,t){var o=S[t];return Object.keys(o).forEach(function(t){u(o[t],e[t])&&(o[t]=e[t])}),t}function u(e,t){return e instanceof Array?!_.isEqual(e,t):e!==t}function f(){if(console.info("Clearing excess items"),S>h.maxNumStories){var e=new Worker(h.workerRemoveItemsPath);e.postMessage({items:S,limit:h.maxNumStories}),e.onmessage=function(t){var o=t.data;o instanceof Array&&o.length>0&&o.forEach(function(e){var t=a(e);t>=0&&S.splice(t,1)}),e.terminate()},e.onerror=function(t){console.error("worker ERROR"),console.error(t),e.terminate()}}}function d(e,o){e.forEach(function(e){if(g+=1,p>=g){var r=t.getItemComment(e);r.then(function(e){Utils.isEmpty(e)||(e.kids.length>0&&d(e.kids,e.childComments),o.push(e))})}})}function v(t){var o=e.get(t);return(Utils.isEmpty(o)||isNaN(o))&&(o=0),o}var h={localStorage:o.localStorage,refreshStoriesInterval:6e4,maxNumStories:100,clearExcessItemsTimeout:2e4,workerRemoveItemsPath:"app/worker/removeExcessItems.min.js"},g=0,p=25,S=[],C={},y=r("sprintf");return function(){var t=e.get(h.localStorage.storiesKey);S=t instanceof Array?t:[],n(s,h.refreshStoriesInterval),s()}(),{storiesList:S,getStories:s,storyComments:C,getStory:function(e){var t=a(e);return S[t]},getComments:function(t,o){var r=y(h.localStorage.commentsFormatKey,t),n=y(h.localStorage.commentsExpirationFormatKey,h.localStorage.expirationPrefixKey,r),s=a(t),c=e.get(r),m=v(n);!o&&m>Math.floor(Date.now())&&!Utils.isEmpty(c)?(console.info("Getting comments from local storage"),C[t]=c):(g=0,C[t]=[],console.info("Getting comments from API"),d(S[s].commentsIds,C[t]),i(function(){console.info("Saving comments to localStorage"),e.set(r,C[t]),e.set(n,Date.now()+36e5)},1e4))}}}]);