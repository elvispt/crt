var CRT=angular.module("CRT",["ngRoute","ngAnimate","LocalStorageModule","ngUtils","sprintf","dotjem.angular.tree"]);CRT.config(["$routeProvider",function(e){e.when("/",{templateUrl:"app/partial/list_stories.html",controller:"HackerNewsController"}).otherwise({redirectTo:"/"})}]),CRT.config(["localStorageServiceProvider",function(e){e.setPrefix("CRT").setStorageType("localStorage").setNotify(!0,!0)}]),CRT.controller("HackerNewsController",["$scope","$filter","$timeout","$q","HackerNewsAPI","localStorageService","NavbarService",function(e,t,o,r,n,i,s){"use strict";function c(e){if(void 0!==e&&void 0!==e.kids&&!e.dead){var t=""!==e.url?e.url:g(v.commentsURL,e.id),o=g(v.commentsURL,e.id),r="";try{r=new URL(""!==e.url?e.url:o).hostname,r=r.replace("www.","")}catch(n){console.log("Failed getting hostname: "+n),r=o}return{id:e.id,url:t,commentsURL:o,commentsIds:e.kids,commentsCount:e.descendants,author:e.by,title:e.title,text:e.text,domain:r,time:e.time,score:e.score}}}function a(){var t=e.hnews;if(e.hnews.length>v.maxNumStories){var o=null,r=864e13;t.forEach(function(e,t){e.time<r&&(o=t)}),o&&"number"==typeof o&&e.hnews.splice(o,1),a()}}function l(){var e=n.topStories();e.then(function(e){e.forEach(function(e){var t=n.getItem(e);t.then(function(e){m(c(e))})})})}function m(t){var o=-1;return void 0!==t&&(o=_.findIndex(e.hnews,function(e){return e.id===t.id}),o=-1===o?u(t):d(t,o)),o}function u(t){return console.log("New story added"),e.hnews.push(t)-1}function d(t,o){var r=e.hnews[o];return angular.forEach(t,function(n,i){!function(){var s=!1;s="commentsIds"===i?r[i].length!==n.length:r[i]!==n,s&&(e.hnews[o]=t,console.log("Story updated"))}()}),o}function f(e,t){p+=e.length,void 0===t&&(t=[]),e.forEach(function(e){var o=n.getItem(e);o.then(function(e){if(h(e)){var o={id:e.id,author:e.by,text:e.text,time:e.time,kids:e.kids?e.kids:[],childComments:[]};o.kids.length>0&&f(o.kids,o.childComments),t.push(o)}})})}function h(e){return null!==e&&void 0!==e&&!e.hasOwnProperty("dead")&&void 0!==e.text}var v={commentsURL:"https://news.ycombinator.com/item?id=%s",storiesLocalStorageKey:"hackernews",maxNumStories:200,clearExcessItemsTimeout:5e3},w=t("orderBy"),g=t("sprintf"),p=0;e.$on("sortCommand",function(t,o,r){e.hnews=w(e.hnews,o,r)}),e.$on("refreshCommand",function(){l()}),e.loadComments=function(t,o){var r=_.findIndex(e.hnews,function(e){return e.id===t});if(-1!==r){if(e.loader[t]=!e.loader[t],e.comments[t]=[],!o)return void(e.loader[t]=!1);p=0,f(e.hnews[r].commentsIds,e.comments[t]);var n=setInterval(function(){p>=e.hnews[r].commentsCount&&(e.$apply(function(){e.loader[t]=!1}),clearInterval(n))},500)}},e.timeAgoFromEpochTime=function(e){return Utils.timeAgoFromEpochTime(e)},function(){var t=i.get(v.storiesLocalStorageKey);e.hnews=t instanceof Array?t:[],e.comments={},e.loader={},e.search=s.search,i.bind(e,"hnews",e.hnews,v.storiesLocalStorageKey),o(a,v.clearExcessItemsTimeout),l()}(),window.scope=e}]),CRT.controller("NavbarController",["$scope","$rootScope","NavbarService",function(e,t,o){"use strict";e.filterOrderBy=function(e,o){t.$broadcast("sortCommand",e,o)},e.refreshStories=function(){t.$broadcast("refreshCommand")},function(){e.search=o.search}()}]),CRT.service("HackerNewsAPI",["$filter","$q",function(e,t){"use strict";var o={MaxNumStories:100,hnFirebaseRefs:{topStories:"https://hacker-news.firebaseio.com/v0/topstories",item:"https://hacker-news.firebaseio.com/v0/item/%s"},commentsURL:"https://news.ycombinator.com/item?id=%s"},r=e("sprintf"),n={};return n.topStories=function(){var e=t.defer();return new Firebase(o.hnFirebaseRefs.topStories).limitToFirst(o.MaxNumStories).once("value",function(t){var o=t.val();o instanceof Array?e.resolve(o):e.reject([])},function(t){console.log("The read failed: "+t.code),e.reject([])}),e.promise},n.getItem=function(e){var n=t.defer();return new Firebase(r(o.hnFirebaseRefs.item,e)).orderByChild("id").once("value",function(e){n.resolve(e.val())},function(e){console.log("The read failed: "+e.code),n.reject([])}),n.promise},n}]),CRT.factory("NavbarService",function(){"use strict";var e={};return e.search={term:""},e});