var CRT=angular.module("CRT",["ngRoute","ngAnimate","LocalStorageModule","ngUtils","sprintf","dotjem.angular.tree"]);CRT.config(["$routeProvider",function(e){e.when("/",{templateUrl:"app/partial/list_stories.html",controller:"HackerNewsController"}).otherwise({redirectTo:"/"})}]),CRT.config(["localStorageServiceProvider",function(e){e.setPrefix("CRT").setStorageType("localStorage").setNotify(!0,!0)}]),CRT.controller("HackerNewsController",["$scope","$filter","$timeout","$interval","HackerNewsAPI","localStorageService","NavbarService",function(e,n,t,o,r,i,s){"use strict";function c(){if(console.info("Clearing excess items"),e.hnews.length>h.maxNumStories){var n=new Worker(h.workerRemoveItemsPath);n.postMessage({items:e.hnews,limit:h.maxNumStories}),n.onmessage=function(t){var o=t.data;o instanceof Array&&o.length>0&&(o.forEach(function(n){var t=_.findIndex(e.hnews,function(e){return e.id===n});t>=0&&e.hnews.splice(t,1)}),e.$apply(function(){e.numItems=e.hnews.length})),n.terminate()},n.onerror=function(e){console.error("worker ERROR"),console.error(e),n.terminate()}}}function a(){var e=r.topStories();e.then(function(e){e.forEach(function(e){var n=r.getItem(e);n.then(function(e){m(e)})})}),t(c,h.clearExcessItemsTimeout)}function m(n){var t=-1;return void 0!==n&&(t=_.findIndex(e.hnews,function(e){return e.id===n.id}),t=-1===t?l(n):u(n,t)),t}function l(n){return console.info("New story added"),e.numItems=e.hnews.length,e.hnews.push(n)-1}function u(n,t){var o=e.hnews[t];return Object.keys(o).forEach(function(e){f(o[e],n[e])&&(o[e]=n[e])}),t}function f(e,n){return e instanceof Array?!_.isEqual(e,n):e!==n}function d(e,n){void 0===n&&(n=[]),e.forEach(function(e){if(w+=1,g>=w){var t=r.getItemComment(e);t.then(function(e){e&&(e.kids.length>0&&d(e.kids,e.childComments),n.push(e))})}})}var h={storiesLocalStorageKey:"hackernews",maxNumStories:100,clearExcessItemsTimeout:2e4,refreshStoriesInterval:6e4,workerRemoveItemsPath:"app/worker/removeExcessItems.min.js"},v=n("orderBy"),w=0,g=20;!function(){var n=i.get(h.storiesLocalStorageKey);e.hnews=n instanceof Array?n:[],e.comments={},e.loader={},e.search=s.search,e.numItems=e.hnews.length,i.bind(e,"hnews",e.hnews,h.storiesLocalStorageKey),a(),o(a,h.refreshStoriesInterval)}(),e.$on("sortCommand",function(n,t,o){e.hnews=v(e.hnews,t,o)}),e.$on("refreshCommand",function(){a()}),e.loadComments=function(n,t){var o=_.findIndex(e.hnews,function(e){return e.id===n});if(-1!==o){if(e.loader[n]=!e.loader[n],e.comments[n]=[],!t)return void(e.loader[n]=!1);w=0,d(e.hnews[o].commentsIds,e.comments[n]);var r=setInterval(function(){(w>=g||w>=e.hnews[o].commentsIds.length)&&(e.$apply(function(){e.loader[n]=!1}),clearInterval(r))},1e3)}},e.loadCommentsChildren=function(e){w=0,d(e.kids,e.childComments)},e.loadMoreComments=function(n){var t=_.findIndex(e.hnews,function(e){return e.id===n}),o=_.difference(e.hnews[t].commentsIds,_(e.comments[n]).filter("id").map(function(e){return e.id}).value());w=0,d(o,e.comments[n])},e.timeAgoFromEpochTime=function(e){return Utils.timeAgoFromEpochTime(e)},e.resetNewsList=function(){console.info("Removing and refreshing news list"),e.hnews=[],e.comments=[],a()},e.clearLocalStorage=function(){console.info("Clearing Local Storage"),i.clearAll()},window.scope=e}]),CRT.controller("NavbarController",["$scope","$rootScope","NavbarService",function(e,n,t){"use strict";e.filterOrderBy=function(e,t){n.$broadcast("sortCommand",e,t)},e.refreshStories=function(){n.$broadcast("refreshCommand")},function(){e.search=t.search}()}]),CRT.service("HackerNewsAPI",["$filter","$q",function(e,n){"use strict";function t(e){if(void 0!==e&&void 0!==e.kids&&!e.dead){var n=""!==e.url?e.url:c(s.commentsURL,e.id),t=c(s.commentsURL,e.id),o="";try{o=new URL(""!==e.url?e.url:t).hostname,o=o.replace("www.","")}catch(r){console.log("Failed getting hostname: "+r),o=t}return{id:e.id,url:n,commentsURL:t,commentsIds:e.kids,commentCount:e.descendants,author:e.by,title:e.title,text:e.text,domain:o,time:e.time,score:e.score}}}function o(e){return r(e)?{id:e.id,author:e.by,text:e.text,time:e.time,kids:e.kids||[],childComments:[]}:void 0}function r(e){return null!==e&&void 0!==e&&!e.hasOwnProperty("dead")&&void 0!==e.text}function i(e,r){var i=n.defer();return new Firebase(c(s.hnFirebaseRefs.item,e)).orderByChild("id").once("value",function(e){i.resolve(r===a?o(e.val()):t(e.val()))},function(e){console.log("The read failed: "+e.code),i.reject(!1)}),i.promise}var s={maxNumStories:100,hnFirebaseRefs:{topStories:"https://hacker-news.firebaseio.com/v0/topstories",item:"https://hacker-news.firebaseio.com/v0/item/%s"},commentsURL:"https://news.ycombinator.com/item?id=%s"},c=e("sprintf"),a="CMT",m={};return m.topStories=function(){var e=n.defer();return new Firebase(s.hnFirebaseRefs.topStories).limitToFirst(s.maxNumStories).once("value",function(n){var t=n.val();t instanceof Array?e.resolve(t):e.reject([])},function(n){console.log("The read failed: "+n.code),e.reject([])}),e.promise},m.getItem=function(e){return i(e)},m.getItemComment=function(e){return i(e,a)},m}]),CRT.factory("NavbarService",function(){"use strict";var e={};return e.search={term:""},e});